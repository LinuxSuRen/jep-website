<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>My New Hugo Site </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.40-DEV" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.e08a958ae3e530145318b6373195c765.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="" />
<meta property="og:description" content="Table 1. Metadata     JEP
 213
   Title
 Configuration Storage API in the Jenkins Core
   Sponsor
 Oleg Nenashev
   Status
 Draft :speech_balloon:
   Type
 Standards
   Created
 2018-08-08
   BDFL-Delegate
 TBD
   JIRA
 JENKINS-51966
   Discussions-To
 Jenkins Cloud Native SIG
     Table of Contents Abstract Specification Scope of changes Changes in the Jenkins Core NEW: FileStorage and XmlFileStorage API UPD: Jenkins class UPD: XmlFile UPD: XmlFile#getFile() cleanup NEW: Filesystem XML storage   Reference implementations Kubernetes Configuration Storage Library SQL Configuration Storage Library   Packaging   Motivation Reasoning Prior work Focus on hudson." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/jep/213/readme/" />
















<meta itemprop="name" content="">
<meta itemprop="description" content="Table 1. Metadata     JEP
 213
   Title
 Configuration Storage API in the Jenkins Core
   Sponsor
 Oleg Nenashev
   Status
 Draft :speech_balloon:
   Type
 Standards
   Created
 2018-08-08
   BDFL-Delegate
 TBD
   JIRA
 JENKINS-51966
   Discussions-To
 Jenkins Cloud Native SIG
     Table of Contents Abstract Specification Scope of changes Changes in the Jenkins Core NEW: FileStorage and XmlFileStorage API UPD: Jenkins class UPD: XmlFile UPD: XmlFile#getFile() cleanup NEW: Filesystem XML storage   Reference implementations Kubernetes Configuration Storage Library SQL Configuration Storage Library   Packaging   Motivation Reasoning Prior work Focus on hudson.">



<meta itemprop="wordCount" content="2263">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Table 1. Metadata     JEP
 213
   Title
 Configuration Storage API in the Jenkins Core
   Sponsor
 Oleg Nenashev
   Status
 Draft :speech_balloon:
   Type
 Standards
   Created
 2018-08-08
   BDFL-Delegate
 TBD
   JIRA
 JENKINS-51966
   Discussions-To
 Jenkins Cloud Native SIG
     Table of Contents Abstract Specification Scope of changes Changes in the Jenkins Core NEW: FileStorage and XmlFileStorage API UPD: Jenkins class UPD: XmlFile UPD: XmlFile#getFile() cleanup NEW: Filesystem XML storage   Reference implementations Kubernetes Configuration Storage Library SQL Configuration Storage Library   Packaging   Motivation Reasoning Prior work Focus on hudson."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://example.org/" class="f3 fw2 hover-white no-underline white-90 dib">
      My New Hugo Site
    </a>
    <div class="flex-l items-center">
      
      









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1"></h1>
      
      <time class="f6 mv4 dib tracked" datetime="0001-01-01T00:00:00Z">January 1, 0001</time>
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><div id="preamble">
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Metadata</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">JEP</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">213</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Title</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration Storage API in the Jenkins Core</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Sponsor</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/oleg-nenashev">Oleg Nenashev</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Status</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft :speech_balloon:</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Type</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standards</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Created</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">2018-08-08</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">BDFL-Delegate</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">TBD</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">JIRA</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.jenkins-ci.org/browse/JENKINS-51966">JENKINS-51966</a></p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Discussions-To</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://groups.google.com/forum/#!forum/jenkins-cloud-native-sig">Jenkins Cloud Native SIG</a></p></td>
</tr>
</tbody>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_abstract">Abstract</a></li>
<li><a href="#_specification">Specification</a>
<ul class="sectlevel2">
<li><a href="#_scope_of_changes">Scope of changes</a></li>
<li><a href="#_changes_in_the_jenkins_core">Changes in the Jenkins Core</a>
<ul class="sectlevel3">
<li><a href="#_new_filestorage_and_xmlfilestorage_api">NEW: FileStorage and XmlFileStorage API</a></li>
<li><a href="#_upd_jenkins_class">UPD: Jenkins class</a></li>
<li><a href="#_upd_xmlfile">UPD: XmlFile</a></li>
<li><a href="#_upd_xmlfile_getfile_cleanup">UPD: XmlFile#getFile() cleanup</a></li>
<li><a href="#_new_filesystem_xml_storage">NEW: Filesystem XML storage</a></li>
</ul>
</li>
<li><a href="#_reference_implementations">Reference implementations</a>
<ul class="sectlevel3">
<li><a href="#_kubernetes_configuration_storage_library">Kubernetes Configuration Storage Library</a></li>
<li><a href="#_sql_configuration_storage_library">SQL Configuration Storage Library</a></li>
</ul>
</li>
<li><a href="#_packaging">Packaging</a></li>
</ul>
</li>
<li><a href="#_motivation">Motivation</a></li>
<li><a href="#_reasoning">Reasoning</a>
<ul class="sectlevel2">
<li><a href="#_prior_work">Prior work</a></li>
<li><a href="#_focus_on_code_hudson_xmlfile_code">Focus on <code>hudson.XmlFile</code></a></li>
<li><a href="#_why_not_extensionpoint_in_the_plugin">Why not “ExtensionPoint” in the plugin?</a></li>
<li><a href="#_limiting_the_configuration_term">Limiting the "configuration" term</a></li>
<li><a href="#_requiring_restart_to_apply_new_configuration_storage_settings">Requiring restart to apply new Configuration storage settings</a></li>
<li><a href="#_data_migration">Data migration</a></li>
<li><a href="#_caching_of_configuration_files">Caching of configuration files</a></li>
</ul>
</li>
<li><a href="#_backwards_compatibility">Backwards Compatibility</a></li>
<li><a href="#_security">Security</a>
<ul class="sectlevel2">
<li><a href="#_filesystem_based_storage">Filesystem-based storage</a></li>
<li><a href="#_critical_plugins">Critical plugins</a></li>
<li><a href="#_new_storage_implementations">New storage implementations</a></li>
</ul>
</li>
<li><a href="#_infrastructure_requirements">Infrastructure Requirements</a>
<ul class="sectlevel2">
<li><a href="#_jenkins_io_and_jira">jenkins.io and JIRA</a></li>
<li><a href="#_test_infrastructure">Test Infrastructure</a></li>
</ul>
</li>
<li><a href="#_testing">Testing</a>
<ul class="sectlevel2">
<li><a href="#_functional_testing">Functional testing</a>
<ul class="sectlevel3">
<li><a href="#_file_based_configuration_storage">File-based configuration storage</a></li>
<li><a href="#_kubernetes_configuration_storage">Kubernetes Configuration Storage</a></li>
<li><a href="#_sql_configuration_storage_library_2">SQL Configuration Storage Library</a></li>
</ul>
</li>
<li><a href="#_pct_ath">PCT/ATH</a></li>
<li><a href="#_performance_testing">Performance Testing</a></li>
</ul>
</li>
<li><a href="#_prototype_implementation">Prototype Implementation</a></li>
<li><a href="#_references">References</a></li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_abstract">Abstract</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This JEP documents how Pluggable Configuration storage should be implemented in Jenkins.
This design addresses the following top-level requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jenkins core is updated to offer a pluggable Configuration Storage Implementation</p>
</li>
<li>
<p>Jenkins core implements API for <code>XmlFileStorage</code> and, optionally, API for other storage types</p>
</li>
<li>
<p>Filesystem-based storage is offered as a fallback</p>
</li>
<li>
<p>The extension should be available before very first Jenkins logic starts up (config.xml reading, etc.). Likely it means that implementations should be in bundled libraries,</p>
<div class="ulist">
<ul>
<li>
<p>Storage is configurable via system properties (similar as what PluginManager and UpdateSite extensions do) or by a MetaInfServices-implementation</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specification">Specification</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_scope_of_changes">Scope of changes</h3>
<div class="paragraph">
<p>The following changes are required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Modification of the Jenkins core</p>
</li>
<li>
<p>jenkins.io or Wiki updates (documentation)</p>
</li>
<li>
<p>Repository with demos and CI flow definitions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Reference implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Filesystem-based XML storage (compatibility mode)</p>
</li>
<li>
<p>K8s storage</p>
</li>
<li>
<p>SQL Storage</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_changes_in_the_jenkins_core">Changes in the Jenkins Core</h3>
<div class="sect3">
<h4 id="_new_filestorage_and_xmlfilestorage_api">NEW: FileStorage and XmlFileStorage API</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p><strong>(oleg-nenashev)</strong>
Needs to be documented when <a href="https://github.com/jenkinsci/jenkins/pull/3393" class="bare">https://github.com/jenkinsci/jenkins/pull/3393</a> is updated,
Maybe there should be a "FileStorage" API retained, TBD</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>There is an XmlFileStorage base class offered in the core</p>
</li>
<li>
<p>The implementation is similar to <a href="https://github.com/jenkinsci/jenkins/pull/3393">jenkins/pull/3393</a>, BUT&#8230;&#8203;</p>
<div class="ulist">
<ul>
<li>
<p>The implementation is binary compatible</p>
</li>
<li>
<p>The implementation takes changes in Kubeify into the account</p>
</li>
<li>
<p>The implementation has a <code>preflightCheck()</code> method which allows checking that the storage is operational</p>
</li>
</ul>
</div>
</li>
<li>
<p>API requirements:</p>
<div class="ulist">
<ul>
<li>
<p>XmlFileStorage offers all API methods required for XMLFile to operate correctly.
Final API will be determined during the reference implementation prototyping</p>
</li>
<li>
<p>API should offer atomic CRUD operations against files</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_upd_jenkins_class">UPD: Jenkins class</h4>
<div class="ulist">
<ul>
<li>
<p>There is a new API in the Jenkins class, which allows getting storages and configuring them for tests</p>
</li>
<li>
<p>When Jenkins starts up, it checks a “io.jenkins.storage.primaryXmlFileStorageClass” and “io.jenkins.storage.fallbackXmlFileStorageClass” system property. If it is set, Jenkins saves reference to this storage implementations</p>
<div class="ulist">
<ul>
<li>
<p>The properties is configured via SystemProperties, so it can be set via web.xml in WAR packaging</p>
</li>
<li>
<p>“io.jenkins.storage.primaryXmlFileStorageClass” defaults to Filesystem storage.</p>
</li>
<li>
<p>“io.jenkins.storage.fallbackXmlFileStorageClass” defaults to Filesystem storage, but can be disabled (may be null for API)</p>
</li>
<li>
<p>If class names are missing, it leads to immediate startup failure</p>
</li>
</ul>
</div>
</li>
<li>
<p>For both primary and fallback storages Jenkins invokes a preflightCheck()</p>
<div class="ulist">
<ul>
<li>
<p>Negative results for both storages lead to a critical startup failure</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_upd_xmlfile">UPD: XmlFile</h4>
<div class="paragraph">
<p><code>hudson.XmlFile</code> should be updated in order to pick-up the new <code>XmlFileStorage</code> implementation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When an XmlFile Object is created, it consults with the Jenkins instance to get the configured storage</p>
</li>
<li>
<p>When reading/writing objects, XmlFile tries the XmlFileStorage defined in the global configuration</p>
</li>
<li>
<p>If a fallback XmlFileStorage is set, XmlFile will also try to fallback to Filesystem storage
if the main storage is not set</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_xmlfile_api_compatibility">XmlFile API Compatibility</h5>
<div class="paragraph">
<p>XMLStorage implementation should retain compatibility in new implementations.</p>
</div>
<div class="paragraph">
<p>Some methods may require extra patches in the XmlFileStorage Implementation.
The only critical method is getFile(),
because it is supposed to provide path to local filesystem which is not offered.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Caching is done via XMLFileCache defined on the XmlFileStorage level (see below)</p>
</li>
<li>
<p>getFile() documentation should be explicit that the method is deprecated (and why)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_upd_xmlfile_getfile_cleanup">UPD: XmlFile#getFile() cleanup</h4>
<div class="ulist">
<ul>
<li>
<p>This is a wide-open task: “Review plugins for getFile() usages in Jenkins core and modules”</p>
</li>
<li>
<p>If there are any quick-wins create patches in the reference implementations</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_new_filesystem_xml_storage">NEW: Filesystem XML storage</h4>
<div class="paragraph">
<p>This is a compatibility layer for the existing Filesystem-based engine.
Existing implementation in XmlFile should be refactored out to a default storage implementation.
To retain the backward compatibility,
<code>preflightCheck()</code> should be noop even if some edge cases could be verified on the Jenkins startup.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reference_implementations">Reference implementations</h3>
<div class="sect3">
<h4 id="_kubernetes_configuration_storage_library">Kubernetes Configuration Storage Library</h4>
<div class="paragraph">
<p>This is a reference implementation which can be used natively in Kubernetes.
It may be used in projects like Jenkins X.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This is a new library to be created</p>
</li>
<li>
<p>The most of the code can be taken from Kubeify prototype</p>
</li>
<li>
<p>The library should be hosted within the Jenkins or Jenkins X organization on GitHub</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Structure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The repository is implemented as a “jar” or “jenkins-module” packaging</p>
</li>
<li>
<p>Jenkins dependencies are “Provided”, there is no plan to run the library outside Jenkins</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What should the repository include?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kubernetes Client</p>
</li>
<li>
<p>Kubernetes XML Storage Implementation</p>
</li>
<li>
<p>Integration tests (See “Testing” below)</p>
</li>
<li>
<p>Custom WAR Packager specification for building Custom WAR for Testing</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_sql_configuration_storage_library">SQL Configuration Storage Library</h4>
<div class="paragraph">
<p>This is a second reference implementation.
It is similar to the Kubernetes Configuration Storage described above.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_packaging">Packaging</h3>
<div class="paragraph">
<p>Until Pluggable Core Components story (<a href="https://issues.jenkins-ci.org/browse/JENKINS-41196">JENKINS-41196</a>) is ready,
there will be no way to install configuration storage as a plugin.
Instead of that, packaging guidelines will be provided.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Option 1: Adding library to Classpath + Docker Packaging</p>
<div class="ulist">
<ul>
<li>
<p>We provide guidelines how to download the library and install it</p>
</li>
<li>
<p>We offer Docker packaging for it as a part of Jenkins X</p>
</li>
</ul>
</div>
</li>
<li>
<p>Option 2: Building a custom WAR using <a href="https://github.com/jenkinsci/custom-war-packager">Custom WAR Packager</a></p>
<div class="ulist">
<ul>
<li>
<p>Packages everything as a single WAR</p>
</li>
<li>
<p>Demo will be offered in the <em>Kubernetes XML Storage Lib</em> repository</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Particular storage implementations may be also shipped as plugins if they find a way to support that.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Currently Jenkins stores all configurations in the file system within <code>JENKINS_HOME</code>.
Such configuration complicates backup management and disaster recovery,
because <code>JENKINS_HOME</code> contains lots of other information in addition to sensitive configs.</p>
</div>
<div class="paragraph">
<p>Externalizing them is a also critical task for getting highly-available or disposable Jenkins masters.
Currently it is possible to externalize the entire <code>JENKINS_HOME</code> by using shared file storages (e.g. NFS),
but there is no engine in Jenkins which would allow moving files outside the filesystem.
Plugins like <a href="https://plugins.jenkins.io/scm-sync-configuration">SCM Sync Configuration</a>
externalize the configurations,
but they duplicate the information and do not act as a main storage for Jenkins initialization.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reasoning">Reasoning</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_prior_work">Prior work</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/groupon/DotCi/">DotCI</a> -
Custom MongoDB-based storage was implemented for Jenkins</p>
</li>
<li>
<p><a href="https://github.com/jstrachan/jenkins/tree/kubeify">Kubeify</a> -
Patches which offer K8s storage as an implementation for the core.
This implementation is <strong>NOT</strong> pluggable</p>
</li>
<li>
<p><a href="https://github.com/jenkinsci/jenkins/pull/3473">jenkins/pull/3473</a> -
Attempt to support gzipped archiving of XMLs</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_focus_on_code_hudson_xmlfile_code">Focus on <code>hudson.XmlFile</code></h3>
<div class="paragraph">
<p>There are many ways to store configurations in Jenkins,
but 95% of cases are covered by the XmlFile layer
which serializes objects to disk and reads them using the XStream library.
Externalizing these XmlFiles would be a great step forward.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_not_extensionpoint_in_the_plugin">Why not “ExtensionPoint” in the plugin?</h3>
<div class="ulist">
<ul>
<li>
<p>Making XMLStorage an extension point is complicated,
because it causes chicken-and-egg problem
(loading Jenkins configurations on very first stages of the startup, e.g. main config.xml)</p>
</li>
<li>
<p>Pluggable Core Components (<a href="https://issues.jenkins-ci.org/browse/JENKINS-41196">JENKINS-41196</a>) support would allow to implement the feature as a plugin,
but it is not there yet</p>
</li>
<li>
<p>Mitigation: Custom WAR Packager as documented above</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Such configuration implies that the storage type will not be configurable using plugins
like Jenkins Configuration as Code.
Eventually this design concern may be addressed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_limiting_the_configuration_term">Limiting the "configuration" term</h3>
<div class="paragraph">
<p>In Jenkins <code>hudson.XmlFile</code> is widely used to store build records, test results, and other data entries.
So the engine does not implement configurations only.
According to the comment from Jesse Glick,
such configuration types should be probably ignored,
because there are other pluggable storage stories.</p>
</div>
<div class="paragraph">
<p>In the current design, the decision is to apply the storage to all types by default.
There are the following reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implementing such feature may be a shortcut to get a lot of JENKINS_HOME data externalized while other pluggable storage stories are not ready.
E.g., we can offload JUnit and XmlFile-based Coverage reports immediately once the story is done</p>
<div class="ulist">
<ul>
<li>
<p>As Jesse mentioned, for Code Coverage plugins there is no unified format so far.
In longer term <a href="https://github.com/jenkinsci/code-coverage-api-plugin" class="bare">https://github.com/jenkinsci/code-coverage-api-plugin</a> may address this issue.
But for now we concentrate only on XmlFile-typed reports</p>
</li>
</ul>
</div>
</li>
<li>
<p>The story is compatible with new Pluggable storage research activities.
When <code>XmlFile</code> engine is invoked, it already means that the legacy compatibility path is used</p>
</li>
<li>
<p>The design allows <code>XmlFileStorage</code> implementations to opt-out from particular files
based on the object type or file path.
In such case the File-based XML storage will be used so the compatibility is retained.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_requiring_restart_to_apply_new_configuration_storage_settings">Requiring restart to apply new Configuration storage settings</h3>
<div class="paragraph">
<p>The implementation presumes that XMLStorage is not configurable within Jenkins.
Restart is required to apply changes, unless an implementation supports reconfiguration on the flights.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_migration">Data migration</h3>
<div class="ulist">
<ul>
<li>
<p>Migration is possible, because the design allows having 2 XmlFileStorage implementations at the same time (primary and fallback ones)</p>
</li>
<li>
<p>We do not plan to offer automatic migration of existing data in the reference implementation.</p>
</li>
<li>
<p>In order to migrate the data from Filesystem to K8s storage (or from storage 1 &#8658; storage 2), all items need to be re-saved</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_caching_of_configuration_files">Caching of configuration files</h3>
<div class="paragraph">
<p>Original design assumed that there will be caching of <code>XmlFile</code> compatibility layer.
After the initial review is was decided that caching engine would be too complicated
due to the cache invalidation logic.
It was decided that caching, if needed, should be done in implementations instead of the Jenkins core.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backwards_compatibility">Backwards Compatibility</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As any other pluggable storage JEP, this design sets high backward compatibility requirements.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security">Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is no specific security implications for the API design in the Jenkins core:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Storage security is up to the XMLStorage API implementations</p>
</li>
<li>
<p>Implementations may define security requirements in documentation</p>
<div class="ulist">
<ul>
<li>
<p>E.g., for Legacy Filesystem Storage:</p>
<div class="ulist">
<ul>
<li>
<p>There should be no jobs running on the master node[r] and accessing workspaces there, except specially designed job types like Jenkins Pipeline</p>
</li>
<li>
<p>External users must not have read-only access to JENKINS_HOME contents
E.g. for K8s XML Storage</p>
</li>
<li>
<p>K8s configuration must restrict access to the storage so that only Jenkins master container and Jenkins admins have access to it</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If a user decides to violate the documented configuration, it’s his own decision and risk.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>XMLStorage implementations may do some security checks in the preflight() callback in order to mitigate
the risks and enforce security practices.</p>
</div>
<div class="sect2">
<h3 id="_filesystem_based_storage">Filesystem-based storage</h3>
<div class="paragraph">
<p>For this legacy storage it is required that Jenkins retains <strong>Full backward compatibility</strong>,
including cases not explicitly supported by the API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All <code>XmlFile</code> API methods behave in the same way as before</p>
</li>
<li>
<p>All File locations stay the same,
so direct file operations continue working as before</p>
</li>
<li>
<p>All plugins should retain compatibility</p>
</li>
<li>
<p>Features like <em>Old Data Monitor</em> continue working as before</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_critical_plugins">Critical plugins</h3>
<div class="paragraph">
<p>Below there is a list of plugins,
which explicitly rely on <code>XmlFile</code> and
<a href="https://jenkins.io/doc/developer/extensions/jenkins-core/#saveablelistener">SaveableListener</a> APIs in order to perform operations
related to configuration management:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://plugins.jenkins.io/disk-usage">Disk Usage Plugin</a></p>
</li>
<li>
<p><a href="https://plugins.jenkins.io/jobConfigHistory">Job Configuration History</a> (manages system configurations as well)</p>
</li>
<li>
<p><a href="https://plugins.jenkins.io/scm-sync-configuration">SCM Sync Configuration</a></p>
</li>
<li>
<p><a href="https://plugins.jenkins.io/google-cloud-backup">Google Cloud Backup</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_new_storage_implementations">New storage implementations</h3>
<div class="paragraph">
<p>New storage implementations are not obliged to retain compatibility in all cases.
Compatibility must be retained for all cases in the Jenkins core, e.g. <em>Old Data Monitor</em>
or other data migration logic in XStream.</p>
</div>
<div class="paragraph">
<p>For known plugin incompatibilities, for users there should be a quick way to access the pages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There should be a jenkins.io or Wiki page created in order to describe the External Configuration storage story</p>
<div class="ulist">
<ul>
<li>
<p>If there is a Wiki page, it should have a redirect from jenkins.io</p>
</li>
</ul>
</div>
</li>
<li>
<p>The page should provide guidelines about troubleshooting and reporting compatibility issues</p>
</li>
<li>
<p>The page should provide a list of known defects or to reference a JIRA query/dashboard</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_infrastructure_requirements">Infrastructure Requirements</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_jenkins_io_and_jira">jenkins.io and JIRA</h3>
<div class="paragraph">
<p>Jenkins website and JIRA should be updated in order to provide information
about known compatibility issues to Jenkins users.</p>
</div>
</div>
<div class="sect2">
<h3 id="_test_infrastructure">Test Infrastructure</h3>
<div class="paragraph">
<p>There is no special test infrastructure requirements for the implementation.
Testing of the <em>Kubernetes Configuration Storage Library</em> will require a Kubernetes cluster,
but it can be done outside ci.jenkins.io if needed (e.g. within the Jenkins X test environment).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_functional_testing">Functional testing</h3>
<div class="paragraph">
<p>All new tests will be implemented using Jenkins Test Harness.
Jenkins core should include automatic tests which verify that the configuration storage can be configured via API.
Configuration storage implementations also should be tested.</p>
</div>
<div class="sect3">
<h4 id="_file_based_configuration_storage">File-based configuration storage</h4>
<div class="paragraph">
<p>File-based configuration storage will be verified by existing automatic tests available in the Jenkins core.
These tests offer good coverage, and all tests should pass without modification
to satisfy the backward compatibility requirements.</p>
</div>
</div>
<div class="sect3">
<h4 id="_kubernetes_configuration_storage">Kubernetes Configuration Storage</h4>
<div class="ulist">
<ul>
<li>
<p>Tests will be designed to run <strong>only</strong> in the Kubernetes Cluster</p>
<div class="ulist">
<ul>
<li>
<p>Running tests outside K8s would be nice2have, but it is not mandatory</p>
</li>
</ul>
</div>
</li>
<li>
<p>We will need a new “K8sStorageJenkinsRule” for testing</p>
<div class="ulist">
<ul>
<li>
<p>The rule starts up Jenkins and configures it to use the <code>XmlFileStorage</code> implementation for testing</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If there is an applicable K8s Storage Client mocking engine (e.g. via Docker container),
we can add such logic initialization to the rule as well so that tests run outside the K8s cluster</p>
</div>
</div>
<div class="sect3">
<h4 id="_sql_configuration_storage_library_2">SQL Configuration Storage Library</h4>
<div class="paragraph">
<p>SQL Configuration storage test automation can be implemented using existing tools available
in the Jenkins Test Harness framework.
<a href="https://github.com/jenkinsci/docker-fixtures">Docker Fixtures</a> or
<a href="https://github.com/testcontainers/testcontainers-java">Testcontainers</a>
can be used to provision the database using JUnit test rules.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pct_ath">PCT/ATH</h3>
<div class="paragraph">
<p>In order to ensure compatibility of plugins, Plugin Compatibility Tester and Acceptance Test Harness test frameworks will be used.
All plugins mentioned in the <em>Backward Compatibility</em> section should be tested in such way.</p>
</div>
<div class="paragraph">
<p>In order to setup continuous integration, <code>essentialsTest()</code> from the Jenkins Pipeline Library will be used.
Both implementation will be packaged as WARs using <a href="https://github.com/jenkinsci/custom-war-packager">Custom WAR Packager</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_performance_testing">Performance Testing</h3>
<div class="paragraph">
<p>No specific performance testing planned for the reference implementation.
The current design does not introduce significant overhead for the Filesystem-based configuration storage.
API Implementations may have performance testing,
but it is up to the implementation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prototype_implementation">Prototype Implementation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jenkinsci/jenkins/pull/3393" class="bare">https://github.com/jenkinsci/jenkins/pull/3393</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="http://javadoc.jenkins.io/hudson/XmlFile.html">hudson.XmlFile Javadoc</a></p>
</li>
<li>
<p><a href="https://issues.jenkins-ci.org/browse/JENKINS-41196">JENKINS-41196</a> - Pluggable core components</p>
</li>
<li>
<p><a href="https://github.com/jstrachan/jenkins/tree/kubeify">Kubeify</a></p>
</li>
</ul>
</div>
</div>
</div>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy; 2018 My New Hugo Site
  </a>
    <div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
