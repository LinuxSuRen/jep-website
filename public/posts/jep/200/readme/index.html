<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>My New Hugo Site </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.40-DEV" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.e08a958ae3e530145318b6373195c765.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="" />
<meta property="og:description" content="Table 1. Metadata     JEP
 200
   Title
 Switch Remoting/XStream blacklist to a whitelist
   Sponsor
 Jesse Glick
   Status
 Final :lock:
   Type
 Standards
   Created
 2017-10-30
   JIRA
 JENKINS-47736
   BDFL-Delegate
 Oleg Nenashev
     Table of Contents Abstract Specification Extensibility Rollout plan Phase 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/jep/200/readme/" />
















<meta itemprop="name" content="">
<meta itemprop="description" content="Table 1. Metadata     JEP
 200
   Title
 Switch Remoting/XStream blacklist to a whitelist
   Sponsor
 Jesse Glick
   Status
 Final :lock:
   Type
 Standards
   Created
 2017-10-30
   JIRA
 JENKINS-47736
   BDFL-Delegate
 Oleg Nenashev
     Table of Contents Abstract Specification Extensibility Rollout plan Phase 1.">



<meta itemprop="wordCount" content="3517">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Table 1. Metadata     JEP
 200
   Title
 Switch Remoting/XStream blacklist to a whitelist
   Sponsor
 Jesse Glick
   Status
 Final :lock:
   Type
 Standards
   Created
 2017-10-30
   JIRA
 JENKINS-47736
   BDFL-Delegate
 Oleg Nenashev
     Table of Contents Abstract Specification Extensibility Rollout plan Phase 1."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://example.org/" class="f3 fw2 hover-white no-underline white-90 dib">
      My New Hugo Site
    </a>
    <div class="flex-l items-center">
      
      









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1"></h1>
      
      <time class="f6 mv4 dib tracked" datetime="0001-01-01T00:00:00Z">January 1, 0001</time>
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><div id="preamble">
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Metadata</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JEP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Switch Remoting/XStream blacklist to a whitelist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sponsor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/jglick">Jesse Glick</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final :lock:</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standards</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Created</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2017-10-30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JIRA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.jenkins-ci.org/browse/JENKINS-47736">JENKINS-47736</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BDFL-Delegate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/oleg-nenashev">Oleg Nenashev</a></p></td>
</tr>
</tbody>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_abstract">Abstract</a></li>
<li><a href="#_specification">Specification</a>
<ul class="sectlevel2">
<li><a href="#_extensibility">Extensibility</a></li>
<li><a href="#_rollout_plan">Rollout plan</a>
<ul class="sectlevel3">
<li><a href="#_phase_1_remoting_release">Phase 1. Remoting release</a></li>
<li><a href="#_phase_2_weekly_release">Phase 2. Weekly Release</a></li>
<li><a href="#_phase_3_lts_availability">Phase 3. LTS availability</a></li>
<li><a href="#_phase_4_post_release">Phase 4. Post-release</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_motivation">Motivation</a></li>
<li><a href="#_reasoning">Reasoning</a>
<ul class="sectlevel2">
<li><a href="#_concern_about_the_single_whitelist_approach">Concern about the single whitelist approach</a></li>
</ul>
</li>
<li><a href="#_backwards_compatibility">Backwards Compatibility</a></li>
<li><a href="#_security">Security</a></li>
<li><a href="#_infrastructure_requirements">Infrastructure Requirements</a></li>
<li><a href="#_testing">Testing</a>
<ul class="sectlevel2">
<li><a href="#_tested_plugins">Tested Plugins</a></li>
</ul>
</li>
<li><a href="#_reference_implementation">Reference Implementation</a></li>
<li><a href="#_references">References</a></li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_abstract">Abstract</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since its early days, Jenkins has used two object serialization frameworks:
Javaâ€™s built-in API, from the Remoting layer;
and XStream, for persisting configuration and settings.
Both permit any Java class to be loaded merely by specifying its name in the input.</p>
</div>
<div class="paragraph">
<p>This proposal switches the blacklist to a whitelist of a few dozen entries:
for Jenkins to process a third-party class, it must be explicitly approved.
Classes defined in Jenkins core or plugins are exempt, as are a few special categories.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specification">Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main aspect of the change is the introduction of a <code>ClassFilterImpl</code> in Jenkins core which supplants the simple blacklist defined in Remoting.
This filter is applied to all Java or XStream deserialization performed by the Jenkins master (as well as XStream <em>serialization</em>, to "fail fast").
A crude blacklist extension API in Remoting introduced in
<a href="https://jenkins.io/security/advisory/2017-04-26/">2017-04-26</a> is deprecated
in favor of the more general <code>ClassFilter.setDefault</code>, as is the system property <code>hudson.remoting.ClassFilter.DEFAULTS_OVERRIDE_LOCATION</code>.</p>
</div>
<div class="paragraph">
<p>The new filter has several levels of rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>CustomClassFilter</code> implementation may override any behavior. This is discussed in the compatibility section.</p>
</li>
<li>
<p>Classes mentioned in the original blacklist continue to be rejected.</p>
</li>
<li>
<p>Java arrays and enums are accepted, as these are special formats.</p>
</li>
<li>
<p>Java <code>Throwable</code> types are accepted, as they are commonly used in Remoting responses and it is impractical to enumerate every exception that might be thrown.</p>
</li>
<li>
<p>A class defined in Jenkins core, Remoting, or a Jenkins module/plugin is accepted. This does <em>not</em> apply to classes defined in other JARs packaged in <code>WEB-INF/lib/*.jar</code>.</p>
</li>
<li>
<p>Some classes defined in test utilities, by mocking frameworks, etc., are accepted when running inside tests.</p>
</li>
<li>
<p>Classes defined in a <code>RemoteClassLoader</code> (so, already sent to this JVM from a presumably trusted source) are accepted.
This is needed at least by CloudBees Jenkins Operations Center, and clients of the <code>master-to-master-api</code> plugin if there are any.</p>
</li>
<li>
<p>Any other class is accepted if it is explicitly mentioned in a list <code>whitelisted-classes.txt</code> bundled in Jenkins core. These consist of:</p>
<div class="ulist">
<ul>
<li>
<p>Basic Java utility types (see the reference implementation).</p>
</li>
<li>
<p>Some other collection types defined in Google Guava.</p>
</li>
<li>
<p>A handful of safe types defined in some libraries used by Jenkins core.</p>
</li>
<li>
<p>A handful of types used by some plugins known to otherwise fail: Git, Pipeline, Maven, Job DSL, etc.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The whitelist has been built up by repeatedly running a large array of tests against a patched core and collecting relevant errors.
It is expected that the standard whitelist will be expanded somewhat as field reports arrive of less common code paths needing new entries.</p>
</div>
<div class="paragraph">
<p>When a class is (first) rejected, a warning is printed to the system log.
This is particularly useful when scanning large automated test results for regressions caused by this change.
Typically the rejection will also trigger an exception which gets displayed in some other manner.</p>
</div>
<div class="sect2">
<h3 id="_extensibility">Extensibility</h3>
<div class="paragraph">
<p>Plugin developers will be able to whitelist the classes in their libraries/plugins using
the following approaches:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>By providing a custom <code>META-INF/hudson.remoting.ClassFilter</code> resource file in their plugin</p>
</li>
<li>
<p>By adding the <code>Jenkins-ClassFilter-Whitelisted=true</code> manifest entry (<a href="https://github.com/jenkinsci/lib-jenkins-maven-embedder/pull/15">example for Maven</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Old Hudson plugins <strong>may</strong> need an update to be processed as Jenkins plugins by the extensions mentioned above.</p>
</li>
<li>
<p>The manifest should have <code>Short-Name</code>, and any of <code>Plugin-Version</code>/<code>Jenkins-Version</code> entries</p>
</li>
<li>
<p>The entries are known to be fine for Jenkins/Hudson plugin POM versions newer than 1.320 (with default maven-hpi-plugin settings)</p>
</li>
</ul>
</div>
</li>
<li>
<p>By implementing the <code>CustomClassFilter</code> extension point, for dynamic whitelistsâ€”for example, all implementations of some interface.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_rollout_plan">Rollout plan</h3>
<div class="sect3">
<h4 id="_phase_1_remoting_release">Phase 1. Remoting release</h4>
<div class="paragraph">
<p>Target date: Jan 10, 2017</p>
</div>
<div class="paragraph">
<p>JEP-200 requires extra API in Remoting, so <a href="https://github.com/jenkinsci/remoting/pull/208">pull request #208</a>
needs to be delivered in advance.
<a href="https://github.com/oleg-nenashev">@oleg-nenashev</a> will release the following components once the rollout plan is confirmed with the JEP sponsor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remoting</p>
</li>
<li>
<p><a href="https://github.com/jenkinsci/docker-slave">docker-slave</a> (including the <code>latest</code> tag)</p>
</li>
<li>
<p><a href="https://github.com/jenkinsci/docker-jnlp-slave">docker-jnlp-slave</a> images (including the <code>latest</code> tag)</p>
</li>
<li>
<p><a href="https://github.com/jenkinsci/swarm-plugin/">Swarm Plugin Client</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_phase_2_weekly_release">Phase 2. Weekly Release</h4>
<div class="paragraph">
<p>Target date: Jan 13, 2017</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Once this JEP is approved, the <a href="https://jenkins.io/redirect/class-filter/" class="bare">https://jenkins.io/redirect/class-filter/</a> will be created on the Jenkins website</p>
<div class="ulist">
<ul>
<li>
<p>This document should provide a custom guide for creating JIRA issues with the <code>jep-200</code> label</p>
</li>
</ul>
</div>
</li>
<li>
<p>The JEP sponsor will write an announcement blogpost, which will describe the change and provide links to mitigation guidelines</p>
<div class="ulist">
<ul>
<li>
<p>This blog-post will be used as part of the upgrade guideline for LTS</p>
</li>
<li>
<p>Upgrade guidelines should explicitly recommend backing up the instance before the upgrade</p>
</li>
<li>
<p>Upgrade guidelines will also provide whitelisting guidelines to plugin developers</p>
</li>
<li>
<p>The blog post will include a reference to a
<a href="https://wiki.jenkins.io/display/JENKINS/Plugins+affected+by+fix+for+JEP-200">Plugins affected by JEP-200</a> Wiki page,
which will be providing info to Jenkins administrators about new discoveries if any.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Once the blog post draft is approved,
<a href="https://github.com/jenkinsci/jenkins/pull/3120">Jenkins PR #3120</a> will be integrated towards the next weekly release</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After the weekly release the JEP sponsor
(or a group of people nominated by him, <em>JEP-200 maintainer(s)</em>)
will be responsible to provide an extra support for the issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>JEP-200 maintainer(s)</em> will regularly review open defects and triage them</p>
</li>
<li>
<p><em>JEP-200 maintainer(s)</em> may request additional information from the reporter.
Finally, they are expected to communicate the triage outcome.</p>
</li>
<li>
<p>Possible triage outcomes:</p>
<div class="ulist">
<ul>
<li>
<p>Accepted - patch in the plugin. Patch to be proposed by <em>JEP-200 maintainer(s)</em></p>
</li>
<li>
<p>Accepted - update whitelist in the core (similar to <a href="https://github.com/jenkinsci/jenkins/pull/3120/files#diff-ff24cb984ddd641f49a22cc13a90cfd3">these cases</a>),
patch to be proposed by <em>JEP-200 maintainer(s)</em></p>
</li>
<li>
<p>Rejected - functional defect.
<em>JEP-200 maintainer(s)</em> are <strong>not responsible</strong> to fix any issue,
the reporter can use the suggested workarounds.
The issue remains open as a common bug.</p>
</li>
<li>
<p>Rejected - security risk.
In such case the issue will be moved to the SECURITY bugtracker and then handled by the <a href="https://jenkins.io/security/">Jenkins Security team</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>For accepted issues <em>JEP-200 maintainer(s)</em> schedule the fix and communicate ETAs to the reporter</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_phase_3_lts_availability">Phase 3. LTS availability</h4>
<div class="paragraph">
<p>Target Date: Mar 14, 2018 (if the weekly gets accepted to LTS)</p>
</div>
<div class="paragraph">
<p>There is no plan to backport the proposed change to the 2.89.x LTS baseline.
The change will be integrated into the LTS if the
<a href="https://wiki.jenkins.io/display/JENKINS/Governance+Meeting+Agenda">governance meeting</a>
selects a weekly with the integrated change.
Estimated meeting date - Feb 14, 2018.</p>
</div>
<div class="paragraph">
<p>Notes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The change will be referenced in the upgrade guidelines based on the announcement blog post</p>
<div class="ulist">
<ul>
<li>
<p>These guidelines will be updated by the weekly rollout results</p>
</li>
<li>
<p>If there are any unresolved known issues, they will be referenced in the <em>Known Issues</em> section</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_phase_4_post_release">Phase 4. Post-release</h4>
<div class="paragraph">
<p>The change may cause regressions in plugins on updating instances.
In order to mitigate them, we define an extra support policy in the community.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Before May 01, 2018 - <em>JEP-200 maintainer(s)</em> will be responsible to review/triage issues.
It means there will be an extra month of active support.
The process is similar to the one described in the Phase 2 section.</p>
</li>
<li>
<p>After May 01, 2018 - Issues labeled with <code>jep-200</code> will not be regularly reviewed by <em>JEP-200 maintainer(s)</em>,
so the maintainers will be the entry point.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For years, the Jenkins project has received reports of remote code execution (RCE) attacks involving these frameworks.
Typically the attacks involve fairly exotic classes in the Java Platform, or sundry libraries such as Groovy.
The Jenkins CERT has responded to such reports reactively, by blacklisting the affected classes or packages.
That approach has proven unmaintainable, as there is a constant threat of further exploits using unexamined classes.</p>
</div>
<div class="paragraph">
<p>This proposal switches the blacklist to a whitelist of a few dozen entries.</p>
</div>
<div class="paragraph">
<p>In practice it seems that very few plugins actually need to serialize any (third-party) types outside the whitelist.
Many such cases point to dubious design decisions, but to retain compatibility a few such entries are bundled in core.
Plugins or administrators can also expand the whitelist if regressions arise.</p>
</div>
<div class="paragraph">
<p>The past few years have seen a flurry of activity by security researchers regarding Java deserialization vulnerabilities.
The <code>ysoserial</code> attack library has been created to host standard "gadgets";
Moritz Bechler has
<a href="https://github.com/mbechler/marshalsec/">published a survey of the field</a>.</p>
</div>
<div class="paragraph">
<p>While none of the Jenkins CERT team members are experts in this area,
various parties have reported remote code execution (RCE) attacks targeting Jenkins.
In just the past two years, the CERT team has had to issue five security advisories including fixes for deserialization vulnerabilities:
first in
<a href="https://jenkins.io/security/advisory/2015-11-11/">2015-11-11</a>,
when a new <code>ClassFilter</code> blacklist was introduced as a defense; then in
<a href="https://jenkins.io/security/advisory/2016-02-24/">2016-02-24</a>,
<a href="https://jenkins.io/security/advisory/2016-11-16/">2016-11-16</a>,
<a href="https://jenkins.io/security/advisory/2017-02-01/">2017-02-01</a>, and
<a href="https://jenkins.io/security/advisory/2017-04-26/">2017-04-26</a>.
At this point it is difficult to have any confidence that the ever-growing blacklist in fact covers every dangerous class
bundled in the Java Platform, Jenkins core, or commonly used plugins.
Any newly discovered exploit could be a critical breach in Jenkins security, and it may not be responsibly disclosed.</p>
</div>
<div class="paragraph">
<p>The exploit in the last (2017-04-26) advisory, like many of the others, was reported against the Jenkins CLI tool.
Since this historically used Jenkins Remoting, it allowed remote attackersâ€”often even with no authenticationâ€”to run code inside the Jenkins master.
The fallout from this exploit led the CERT team to deprecate use of Remoting in CLI and switch to a safer protocol:
<a href="https://gist.github.com/jglick/9721427da892a9b2f75dc5bc09f8e6b3">JENKINS-41745</a>.
Thus Java deserialization exploits are no longer a threat to users of the recommended CLI modes.</p>
</div>
<div class="paragraph">
<p>Similarly, after 2017-02-01 a potential attack vector involving console notes (markup in Jenkins build logs) was closed:
these must now be signed by a key available only inside Jenkins, and deserialization is only performed after successful signature verification.</p>
</div>
<div class="paragraph">
<p>However, deserialization is still performed on data an attacker could control in two cases.
Messages sent from an agent to the Jenkins master (unprompted, or responses to requests) are normally passed through a "callable whitelist" as of
<a href="https://jenkins.io/security/advisory/2014-10-30/">2014-10-30</a>.
This whitelist is only applied <em>after</em> deserializing the message, though, at which point it may be too late.
Since an agent JVM is assumed to be compromisable with a little effort by a rogue build (for example, of a malicious pull request),
the master must apply a filter on incoming classes.</p>
</div>
<div class="paragraph">
<p>XStream deserialization is also performed when loading job (agent, â€¦) definitions from several REST or CLI commands.
These commands require some authentication and authorization,
but it is worrisome that XStream does not require that a class implement the <code>Serializable</code> interface,
so the reserve of potentially exploitable classes is far broader.
Thus any blacklist which hopes to be exhaustive must include many more classes than typical gadgets attempt to use.</p>
</div>
<div class="paragraph">
<p>(Note: Pipeline builds based on the Groovy CPS engine use yet another serialization framework, JBoss Marshalling, to save state.
This is not considered a security issue since the <code>program.dat</code> files are never read from user data.)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reasoning">Reasoning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The CERT team could continue to expand the blacklist in response to newly reported vulnerabilities.
This has proven to be a significant maintenance burden, and there is little trust in the result.
Outside security authorities have repeatedly urged the Jenkins team to switch to a whitelist.</p>
</div>
<div class="paragraph">
<p>Jenkins could theoretically switch to other designs that do not involve Java object deserialization.
In practice this would be wildly incompatible, requiring a rewrite of much of Jenkins core and most plugins.</p>
</div>
<div class="paragraph">
<p>Every single class used in serial form by Remoting or XStream could be listed.
This would be a gigantic list, however, and would consist mostly of types defined in plugins (thus being antimodular):
it is perfectly common to define callables, settings, or nested "structs" in a plugin for purposes of communication or persistence.
It seems a reasonable compromise to expect that classes defined specifically for use in Jenkins not expose unsafe deserialization behaviors.</p>
</div>
<div class="paragraph">
<p>In the other direction, it would be possible to reduce the size of the whitelist
by automatically approving any third-party class which does not define a custom deserialization method such as <code>readResolve</code>.
(There are some tricky points here involving subclasses, since the Serialization specification allows some inheritance of behaviors.)
This would defend against the most obvious attacks which involve unexpected code execution during deserialization of the exploited class itself.
However, some more subtle gadgets rely on a combination of behaviors:
custom deserialization methods in quite standard classes (usually some kind of collection) which call methods like <code>equals</code> or <code>hashCode</code> on elements;
and unusual classes which have unsafe implementations of these methods.
Some experimentation was done on this strategy,
but in fact the whitelist size increase needed to handle third-party classes with no deserialization methods is not dramatic,
and this seems well worth the added measure of safety and transparency.</p>
</div>
<div class="paragraph">
<p><a href="http://openjdk.java.net/jeps/290">JDK Enhancement Proposal (JEP) 290</a> provides a standard way to apply deserialization filters in Java.
This is not particularly helpful for Jenkins.
There are two kinds of filters in JEP 290: declarative and programmatic.
The programmatic filters would allow the full flexibility that Jenkinsâ€™ <code>ClassFilter</code> requires.
However, this is only available in Java 9 and later, and anyway we already control the <code>ObjectInputStream</code> construction, so it would be functionally equivalent.
(But with no XStream support.)
The declarative filters are available in Java 8, but are too limited
(for example, we cannot automatically approve types defined in Jenkins code);
these have the advantage of applying to any <code>ObjectInputStream</code> in the system,
but that is only really helpful when defending against attacks like the <code>SignedObject</code> exploit in 2017-04-26,
which was already covered by a blacklist entry (and now a lack of whitelisting as well).</p>
</div>
<div class="sect2">
<h3 id="_concern_about_the_single_whitelist_approach">Concern about the single whitelist approach</h3>
<div class="paragraph">
<p><a href="https://github.com/oleg-nenashev">@oleg-nenashev</a> raised a concern about using the same whitelist for Remoting and XStream:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>With the reference implementation in <a href="https://github.com/jenkinsci/jenkins/pull/3120">Jenkins PR #3120</a>
there is no way to approve serialization only for a single serialization type
(e.g. only XStream).</p>
</li>
<li>
<p>Possible attack vectors in Remoting and XStream differ,
especially when Remoting CLI is enabled due to the features missing in other CLI modes (multiple file parameters, etc.).</p>
<div class="ulist">
<ul>
<li>
<p>For attack via XML you usually need <code>Item.CONFIGURE</code> permissions</p>
</li>
<li>
<p>For attack over Remoting - <code>Computer.CONFIGURE</code> or write access to Remoting/Swarm Client JAR files on an agent.
If Remoting CLI is enabled&#8230;&#8203; then there is no special permissions required.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Feedback from the JEP Sponsor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remoting CLI is not a concern since we are going to consider it as insecure
and deprecated option even after integrating</p>
</li>
<li>
<p>Current implementation can be extended in the future if needed.
Jenkins core patch may be required to pass information about the serialization type to
the <code>CustomClassFilter</code> implementations</p>
</li>
<li>
<p><code>CustomClassFilter</code> extension point is restricted now,
so any required adjustements can be made by API users when needed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The BDFL delegate agreed with the provided feedback (Jan 03, 2017).
He would like to see better extensibility in the future, but it does not block delivery of JEP-200.
It is <strong>NOT</strong> a deferred task, JEP Sponsor has no plan to implement it.
If a need arises, it can been contributed by somebody else.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backwards_compatibility">Backwards Compatibility</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is an obvious risk that some plugins will have a legitimate need to serialize and deserialize third-party types not covered in the whitelist.
In fact it is expected that there will be some such cases;
this is simply the cost of having a tighter security policy.</p>
</div>
<div class="paragraph">
<p>To ameliorate the risk we can check automated test results against the patched core,
specifically scanning for the term <code>class-filter</code> which appears in logs whenever a violation is encountered.
Some runs of <code>acceptance-test-harness</code> (ATH) were already performed in this mode.
<code>plugin-compat-tester</code> (PCT) was also run against an array of plugins.
See the list in <em>Appendix A</em> for more details.</p>
</div>
<div class="paragraph">
<p>If new whitelist entries are needed after release, they can be added to core in weekly updates.
Plugins can also contribute their own whitelist (or even blacklist) entries for third-party libraries they bundle,
as described in Extensibility above.</p>
</div>
<div class="paragraph">
<p>Finally, an individual administrator can define site-specific whitelist (or blacklist) entries with a system property <code>hudson.remoting.ClassFilter</code>.
This could be useful as an emergency measure, permitting functionality to be restored while awaiting a new plugin release.
(Such a command-line option could be noted as a workaround in a JIRA bug report by someone familiar with the Jenkins security architecture.)
<code>jenkins.security.ClassFilterImpl.SUPPRESS_WHITELIST</code> disables the whitelist, logging violations, but keeps the blacklist;
<code>jenkins.security.ClassFilterImpl.SUPPRESS_ALL</code> disables them both (which is very dangerous).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security">Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This proposal is expected to strictly improve Jenkins security,
as the existing blacklist is retained as a fallback unless deliberately overridden.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_infrastructure_requirements">Infrastructure Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A new redirect <code><a href="https://jenkins.io/redirect/class-filter/" class="bare">https://jenkins.io/redirect/class-filter/</a></code> has been offered, pointing to a wiki page.
This permalink is printed to log messages appearing when a whitelist violation is encountered;
in these cases plugin developers or administrators are likely to need instructions on how to proceed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This section is listed as described by the JEP Sponsor.
Additional testing has been performed during the JEP-200 review in order to evaluate the proposal.
Testing notes for the JEP review phase can be found in <em>Appendix A</em> and the linked documents.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reference implementation includes test coverage for the essential aspects of the newly added filter:
for example, that an example library class not currently included in the whitelist is rejected under the expected conditions.</p>
</div>
<div class="paragraph">
<p>A number of core tests had already been added during various advisories as mentioned in the motivation.
When the fallback to the original blacklist is disabled, these continue to pass, indicating that the whitelist alone is a good defense.
(In a few cases, some technical changes had to made to these tests to ensure that they exercised a realistic code path.)</p>
</div>
<div class="paragraph">
<p>The interesting testing is however driven by scanning ATH and PCT results for failures mentioning certain keywords,
as detailed in the discussion on backwards compatibility.
The broader the set of plugins which can be included in these test runs, the more regressions will be caught early.</p>
</div>
<div class="paragraph">
<p>For example, a mistake in the <code>dockerhub-notification</code> plugin (that would have caused errors under this proposal)
was already detected by an automated test run, and a simple fix proposed and merged.</p>
</div>
<div class="paragraph">
<p>Testing against this proposal also rediscovered
<a href="https://issues.jenkins-ci.org/browse/JENKINS-47158">JENKINS-47158</a>,
though sufficient reasonable whitelist entries were added to not cause regressions for Blue Ocean even if that were not fixed.</p>
</div>
<div class="paragraph">
<p>In several cases, test failures and consequent whitelist additions highlighted poor design decisions in existing code.
For example, as of
<a href="https://github.com/jenkinsci/git-plugin/pull/497">PR 497</a>
the <code>git</code> plugin does a lot of tricky things with the Eclipse JGit library.
That is true even if you have specified the CLI implementation of Git for use in the build!
In this case, <code>GitSCM.printCommitMessageToLog</code> asks the agent to return a <code>RevCommit</code> (a JGit type),
which is serialized and deserialized, and then the master calls <code>getShortMessage()</code> on that structure.
It would be simpler, faster, and safer to do this processing on the agent and send back a <code>String</code>,
but the deceptive ease of Remoting tempts developers to do the wrong thing.
Enforcing a whitelist in the baseline version of Jenkins might help guide them to the simpler solution.</p>
</div>
<div class="paragraph">
<p>Functional tests (using <code>JenkinsRule</code>) which employ mocking frameworks (Mockito / PowerMock)
force the new filter to be disabled, as the changes to class loading prevent normal operation.
Thus any plugin functionality covered only by mock-based tests might quietly regress.
Fortunately these tests generally check only unit functionality to begin with,
and are not likely to be exercising interesting code paths such as settings storage or remote calls to agents.
For similar reasons, certain tests written in Groovy rather than Java prevent normal filter operation and may fail spuriously.</p>
</div>
<div class="sect2">
<h3 id="_tested_plugins">Tested Plugins</h3>
<div class="paragraph">
<p>During JEP-200 review an extra testing has been performed.
Testing steps and discovered issues are being tracked in
link: <a href="https://docs.google.com/document/d/1uQcyaaLvGFwFDe0mQ27JHeG2icdX0XfCHILbHGOtAmA/edit">JEP-200 Testing Notes</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jenkinsci/acceptance-test-harness">Jenkins Acceptance Test Harness (ATH)</a> has been executed with the patched components, several plugins were fixed (see the <em>Testing</em> section)</p>
<div class="ulist">
<ul>
<li>
<p>Jenkins WAR from <a href="https://github.com/jenkinsci/jenkins/pull/3120">Jenkins PR #3120</a> has been tested with a custom core</p>
</li>
<li>
<p>After reviewing of existing ATH tests we concluded that usage of a custom WAR is not a problem</p>
</li>
<li>
<p>We agreed that testing against obsolete dependencies could be a problem.
During the PR merge procedure the JEP Sponsor and the BDFL Delegate will rerun ATH to confirm there is no issues with stock Jenkins WAR</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://github.com/jenkinsci/plugin-compat-tester">Plugin Compatibility Tester (PCT)</a></p>
<div class="ulist">
<ul>
<li>
<p>Originally PCT has been executed for a limited plugin set for a sponsor&#8217;s custom Jenkins WAR.</p>
</li>
<li>
<p>It was decided that it is not enough (not recent plugin versions, potential impact on the plugin behavior by the custom logic),
so the BDFL delegate and the JEP Sponsor re-run PCT with a standard Jenkins WAR</p>
</li>
<li>
<p>During testing the BDFL Delegate discovered issues which prevent him from running PCT in
particular cases.
These issues are listed in the <a href="https://issues.jenkins-ci.org/browse/JENKINS-48734">JENKINS-48734</a> EPIC.
The blocker issues have been resolved.</p>
</li>
<li>
<p>All plugins recommended in the Jenkins Installation Wizard have been covered as well as many other plugins</p>
</li>
<li>
<p>BDFL delegate has not tested Pipeline and Blue Ocean plugins,
because they are being maintained by employees of the JEP Sponsor&#8217;s company.
According to the JEP sponsor, they were covered by their internal testing procedure.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although there will be extra testing performed before the release of the change in the Weekly,
BDFL confirms that the current test coverage is good enough to accept this Jenkins Enhancement Proposal
(Jan 08, 2017).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reference_implementation">Reference Implementation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jenkinsci/jenkins/pull/3120">Jenkins PR #3120</a> contains the bulk of the change and links to related PRs.</p>
</li>
<li>
<p><a href="https://github.com/jenkinsci/remoting/pull/208">Remoting PR #208</a> introduces the new API required to deliver the change.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://groups.google.com/forum/#!topic/jenkinsci-dev/hOn7DTGv9tw">jenkinsci-dev mailing list thread</a></p>
</li>
<li>
<p><a href="https://docs.google.com/document/d/1uQcyaaLvGFwFDe0mQ27JHeG2icdX0XfCHILbHGOtAmA/edit">JEP-200 Testing Notes (BDFL Review)</a></p>
</li>
<li>
<p><a href="https://github.com/jenkins-infra/jenkins.io/pull/1293">Announcement Blog Post Draft</a></p>
</li>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/Plugins+affected+by+fix+for+JEP-200">Wiki Page: Plugins affected by JEP-200</a></p>
</li>
</ul>
</div>
</div>
</div>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy; 2018 My New Hugo Site
  </a>
    <div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
